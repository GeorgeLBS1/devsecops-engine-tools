---
metadata:
  name: "Ensure EFS has restricted access from unauthorized sources"
  id: "CKV2_AWS_120"
  category: "GENERAL_SECURITY"
definition:
  and:
    - cond_type: "filter"
      attribute: "resource_type"
      value:
        - AWS::EFS::FileSystem
      operator: within
    - cond_type: "connection"
      resource_types:
        - AWS::EFS::FileSystem
      connected_resource_types:
        - AWS::EFS::MountTarget
      operator: exists
    - or:
        - and:
            - cond_type: "attribute"
              resource_types:
                - "AWS::EFS::MountTarget"
              attribute: "FileSystemId"
              operator: "exists"
            - cond_type: "attribute"
              resource_types:
                - "AWS::EFS::MountTarget"
              attribute: "FileSystemId"
              operator: "is_not_empty"
        - and:
            - cond_type: "attribute"
              resource_types:
                - "AWS::EFS::MountTarget"
              attribute: "FileSystemId.Ref"
              operator: "exists"
            - cond_type: "attribute"
              resource_types:
                - "AWS::EFS::MountTarget"
              attribute: "FileSystemId.Ref"
              operator: "is_not_empty"
    - or:
        - and:
            - cond_type: "attribute"
              resource_types:
                - "AWS::EFS::MountTarget"
              attribute: "SubnetId"
              operator: "exists"
            - cond_type: "attribute"
              resource_types:
                - "AWS::EFS::MountTarget"
              attribute: "SubnetId"
              operator: "is_not_empty"
        - and:
            - cond_type: "attribute"
              resource_types:
                - "AWS::EFS::MountTarget"
              attribute: "SubnetId.Ref"
              operator: "exists"
            - cond_type: "attribute"
              resource_types:
                - "AWS::EFS::MountTarget"
              attribute: "SubnetId.Ref"
              operator: "is_not_empty"
    - or:
        - and:
            - cond_type: "attribute"
              resource_types:
                - "AWS::EFS::MountTarget"
              attribute: "SecurityGroups"
              operator: "exists"
            - cond_type: "attribute"
              resource_types:
                - "AWS::EFS::MountTarget"
              attribute: "SecurityGroups"
              operator: "is_not_empty"
        - and:
            - cond_type: "attribute"
              resource_types:
                - "AWS::EFS::MountTarget"
              attribute: "SecurityGroups.Ref"
              operator: "exists"
            - cond_type: "attribute"
              resource_types:
                - "AWS::EFS::MountTarget"
              attribute: "SecurityGroups.Ref"
              operator: "is_not_empty"
