---
metadata:
  name: "Check that API Gateway has Access Logging enabled"
  id: "CKV2_AWS_99"
  category: "GENERAL_SECURITY"
definition:
  or:
########################################## STAGE ACCESSLOGSETTINGS ########################################  
    - cond_type: "attribute"
      resource_types:
      - "AWS::ApiGateway::Stage"
      attribute: "AccessLogSetting.DestinationArn"
      operator: "exists"
########################################## STAGE METHODSETTINGS ########################################        
    - and:
      - cond_type: "attribute"
        resource_types:
        - "AWS::ApiGateway::Stage"
        attribute: "MethodSettings.*.MetricsEnabled"
        operator: "equals"
        value: true
      - cond_type: "attribute"
        resource_types:
        - "AWS::ApiGateway::Stage"
        attribute: "MethodSettings.*.LoggingLevel"
        operator: "exists"
      - or:
        - cond_type: "attribute"
          resource_types:
          - "AWS::ApiGateway::Stage"
          attribute: "MethodSettings.*.LoggingLevel"
          operator: "equals"
          value: ERROR
        - cond_type: "attribute"
          resource_types:
          - "AWS::ApiGateway::Stage"
          attribute: "MethodSettings.*.LoggingLevel"
          operator: "equals"
          value: INFO
########################################## DEPLOYMENT ACCESSLOGSETTINGS ########################################            
    - cond_type: "connection"
      resource_types:
        - AWS::ApiGateway::Deployment
      connected_resource_types:
        - AWS::ApiGateway::Stage
      operator: exists
########################################## SKIP WHEN CONNECTION STAGE AND DEPLOYMENT ########################################            
    - cond_type: "attribute"
      resource_types:
      - "AWS::ApiGateway::Deployment"
      attribute: "StageDescription.AccessLogSetting.DestinationArn"
      operator: "exists"
########################################## DEPLOYMENT METHODSETTINGS ########################################         
    - and:
      - cond_type: "attribute"
        resource_types:
        - "AWS::ApiGateway::Deployment"
        attribute: "StageDescription.MethodSettings.*.MetricsEnabled"
        operator: "equals"
        value: true
      - cond_type: "attribute"
        resource_types:
        - "AWS::ApiGateway::Deployment"
        attribute: "StageDescription.MethodSettings.*.LoggingLevel"
        operator: "exists"
      - or:
        - cond_type: "attribute"
          resource_types:
          - "AWS::ApiGateway::Deployment"
          attribute: "StageDescription.MethodSettings.*.LoggingLevel"
          operator: "equals"
          value: "ERROR"
        - cond_type: "attribute"
          resource_types:
          - "AWS::ApiGateway::Deployment"
          attribute: "StageDescription.MethodSettings.*.LoggingLevel"
          operator: "equals"
          value: "INFO"       
