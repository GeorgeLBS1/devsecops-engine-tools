steps:

- task: UsePythonVersion@0
  displayName: 'Use Python'
  inputs:
    versionSpec: '>= 3.6'
  enabled: false

- script: |
    python3 -m pip install --upgrade pip -i $(ARTIFACTORY_URL) --trusted-host $(ARTIFACTORY_HOST)
    python3 -m pip install setuptools virtualenv wheel -i $(ARTIFACTORY_URL) --trusted-host $(ARTIFACTORY_HOST)
    python3 -m virtualenv _venv
    source _venv/bin/activate
    python -m pip install -r requirements.txt -i $(ARTIFACTORY_URL) --trusted-host $(ARTIFACTORY_HOST)
    python3 setup.py bdist_wheel
    file=$(find dist/ -name "*.whl" -type f -print -quit)
    version=$(echo "$file" | awk -F'-' '{print $2}' | sed 's/^v//')
    echo "Versi√≥n: $version"
    echo "##vso[task.setvariable variable=version]$version"
  workingDirectory: $(System.DefaultWorkingDirectory)/$(componentName)
  displayName: 'Artifact creation'

- task: ArtifactoryGenericUpload@2
  displayName: "Artifactory Generic Upload QA"
  inputs:
    artifactoryService: Artifactory
    fileSpec: |
      {
        "files": [
          {
            "pattern": "$(System.DefaultWorkingDirectory)/$(componentName)/dist/*.whl",
            "target": "$(url_repository_artifactory_qa)/"
          }
        ]
      }

- task: ArtifactoryGenericUpload@2
  displayName: "Artifactory Generic Upload PDN"
  inputs:
    artifactoryService: Artifactory
    fileSpec: |
      {
        "files": [
          {
            "pattern": "$(System.DefaultWorkingDirectory)/$(componentName)/dist/*.whl",
            "target": "common-pypi/devsecops_engine_utilities/$(version)/"
          }
        ]
      }
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/trunk'))
