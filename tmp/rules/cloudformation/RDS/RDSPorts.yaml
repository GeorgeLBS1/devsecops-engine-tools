metadata:
  name: "Ensure RDS uses ports defined by the Bank"
  id: "CKV2_AWS_139"
  category: "NETWORKING"
definition:
  or:
    - and:
      - cond_type: "attribute"
        resource_types:
          - "AWS::RDS::DBInstance"
        attribute: "Port"
        operator: "exists"
      - cond_type: "attribute"
        resource_types:
          - "AWS::RDS::DBInstance"
        attribute: "Port"
        operator: "regex_match"
        value: "5[0-9]{4}"
    - and:
      - cond_type: "connection"
        resource_types:
        - "AWS::RDS::DBInstance"
        connected_resource_types:
        - "AWS::RDS::DBCluster"
        operator: "exists"
      - cond_type: "attribute"
        resource_types:
          - "AWS::RDS::DBInstance"
        attribute: "DBClusterIdentifier"
        operator: "exists"
      - cond_type: "attribute"
        resource_types:
          - "AWS::RDS::DBCluster"
        attribute: "Port"
        operator: "exists"
      - cond_type: "attribute"
        resource_types:
          - "AWS::RDS::DBCluster"
        attribute: "Port"
        operator: "regex_match"
        value: "5[0-9]{4}"
    - and:
      - cond_type: "connection"
        resource_types:
        - "AWS::RDS::DBInstance"
        connected_resource_types:
        - "AWS::RDS::DBCluster"
        operator: "exists"
      - cond_type: "attribute"
        resource_types:
          - "AWS::RDS::DBInstance"
        attribute: "DBClusterIdentifier"
        operator: "exists"
      - cond_type: "attribute"
        resource_types:
          - "AWS::RDS::DBCluster"
        attribute: "EngineMode"
        operator: "exists"
      - cond_type: "attribute"
        resource_types:
          - "AWS::RDS::DBCluster"
        attribute: "EngineMode"
        operator: "equals"
        value: "Serverless"
    