metadata:
    name: "Check that Secret has configured Resource Based policy"
    id: "CKV2_AWS_100"
    category: "GENERAL_SECURITY"
definition:
    and:
        - cond_type: connection
          operator: exists
          resource_types:
              - AWS::SecretsManager::Secret
          connected_resource_types:
              - AWS::SecretsManager::ResourcePolicy
          and:
              - cond_type: attribute
                attribute: ResourcePolicy.Statement.*.Effect
                operator: equals
                value: "Deny"
                resource_types:
                    - AWS::SecretsManager::ResourcePolicy
              - cond_type: attribute
                attribute: ResourcePolicy.Statement.*.Principal
                operator: "regex_match"
                value: ".*\\*.*"
                resource_types:
                    - AWS::SecretsManager::ResourcePolicy
              - cond_type: attribute
                attribute: ResourcePolicy.Statement.*.Action
                operator: contains
                value: "secretsmanager:GetSecretValue"
                resource_types:
                    - AWS::SecretsManager::ResourcePolicy
              - cond_type: attribute
                attribute: ResourcePolicy.Statement.*.Resource
                operator: "regex_match"
                value: ".*\\*.*"
                resource_types:
                    - AWS::SecretsManager::ResourcePolicy
              - or:
                - cond_type: attribute
                  attribute: ResourcePolicy.Statement.*.Condition.StringNotEquals.aws:PrincipalArn
                  operator: exists
                  resource_types:
                     - AWS::SecretsManager::ResourcePolicy
                - cond_type: attribute
                  attribute: ResourcePolicy.Statement.*.Condition.StringNotLike.aws:PrincipalArn
                  operator: exists
                  resource_types:
                     - AWS::SecretsManager::ResourcePolicy
