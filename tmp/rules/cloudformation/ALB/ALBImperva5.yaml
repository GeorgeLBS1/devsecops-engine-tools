---
metadata:
  name: "Check that ELB has configured DDOS Shield use case 5"
  id: "CKV2_AWS_109"
  category: "GENERAL_SECURITY"
definition:
  and:
############################ FILTRO PARA TIPOS DE RECURSOS ############################
    - cond_type: "filter"
      attribute: "resource_type"
      value:
      - "AWS::ElasticLoadBalancing::LoadBalancer"
      - "AWS::ElasticLoadBalancingV2::LoadBalancer"
      operator: "within"
    - or:
############################ Only Application ############################    
      - and: 
        - cond_type: "attribute"
          resource_types:
          - "AWS::ElasticLoadBalancing::LoadBalancer"
          - "AWS::ElasticLoadBalancingV2::LoadBalancer"
          attribute: "Type"
          operator: "not_equals"
          value: "Application"         
############################ ALB SCHEME internal ############################
      - and:
        - cond_type: "attribute"
          resource_types:
          - "AWS::ElasticLoadBalancing::LoadBalancer"
          - "AWS::ElasticLoadBalancingV2::LoadBalancer"
          attribute: "Scheme"
          operator: "exists"
        - cond_type: "attribute"
          resource_types:
          - "AWS::ElasticLoadBalancing::LoadBalancer"
          - "AWS::ElasticLoadBalancingV2::LoadBalancer"
          attribute: "Scheme"
          operator: "equals"
          value: "internal"
########################### ALB SCHEME internet-facing ############################
      - and:
        - or:
          - cond_type: "attribute"
            resource_types:
            - "AWS::ElasticLoadBalancing::LoadBalancer"
            - "AWS::ElasticLoadBalancingV2::LoadBalancer"
            attribute: "Scheme"
            operator: "not_exists"
          - and:
            - cond_type: "attribute"
              resource_types:
              - "AWS::ElasticLoadBalancing::LoadBalancer"
              - "AWS::ElasticLoadBalancingV2::LoadBalancer"
              attribute: "Scheme"
              operator: "exists"
            - cond_type: "attribute"
              resource_types:
              - "AWS::ElasticLoadBalancing::LoadBalancer"
              - "AWS::ElasticLoadBalancingV2::LoadBalancer"
              attribute: "Scheme"
              operator: "equals"
              value: "internet-facing"
########################### NO EXISTE CLOUDFRONT O EXISTE CLOUDFRONT PERO CON CUSTOM ORIGIN NO VINCULADO AL ALB O NO CUSTOM ACL VINCULADA AL ALB ############################
        - or:
          - and:
            - cond_type: "attribute"
              resource_types:
              - "AWS::CloudFront::Distribution"
              attribute: "DistributionConfig.Origins.S3OriginConfig"
              operator: "not_exists"
            - cond_type: "attribute"
              resource_types:
              - "AWS::CloudFront::Distribution"
              attribute: "DistributionConfig.Origins.CustomOriginConfig"
              operator: "not_exists"
          - and:
            - cond_type: "attribute"
              resource_types:
              - "AWS::CloudFront::Distribution"
              attribute: "DistributionConfig.Origins.CustomOriginConfig"
              operator: "exists"
            - cond_type: "connection"
              resource_types:
              - "AWS::CloudFront::Distribution"
              connected_resource_types:
              - "AWS::ElasticLoadBalancing::LoadBalancer"
              - "AWS::ElasticLoadBalancingV2::LoadBalancer"
              operator: "not_exists"
          - and:
            - cond_type: "filter"
              attribute: "resource_type"
              value:
              - "AWS::ElasticLoadBalancing::LoadBalancer"
              - "AWS::ElasticLoadBalancingV2::LoadBalancer"
              operator: "within"
            - cond_type: "connection"
              resource_types:
              - "AWS::ElasticLoadBalancing::LoadBalancer"
              - "AWS::ElasticLoadBalancingV2::LoadBalancer"
              connected_resource_types:
              - "Custom::customaclupdate"
              operator: "not_exists"
