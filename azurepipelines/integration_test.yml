steps:

- task: UsePythonVersion@0
  displayName: 'Use Python'
  inputs:
    versionSpec: '>= 3.6'
  enabled: false

- script:  |
    python3 -m pip install --upgrade pip -i $(ARTIFACTORY_URL) --trusted-host $(ARTIFACTORY_HOST)
    python3 -m pip install virtualenv -i $(ARTIFACTORY_URL) --trusted-host $(ARTIFACTORY_HOST)
    python3 -m virtualenv _venv
  displayName: install python basics

- script: |
    if [ "$(Build.SourceBranch)" == "refs/heads/trunk" ]; then
      echo "Integration tests are only run in feature branch"
    else
      source _venv/bin/activate
      python -m pip install --upgrade pip -i $(ARTIFACTORY_URL) --trusted-host $(ARTIFACTORY_HOST)
      python -m pip install -r requirements.txt -i $(ARTIFACTORY_URL) --trusted-host $(ARTIFACTORY_HOST)
      python -m pip install -r requirements_test.txt -i $(ARTIFACTORY_URL) --trusted-host $(ARTIFACTORY_HOST)
      python test_integrations_defect_dojo.py
    fi
  workingDirectory: $(System.DefaultWorkingDirectory)/$(pathComponentName)
  displayName: 'Integration Test'
  env:
    PERSONAL_ACCESS_TOKEN: $(System.AccessToken)
    TOKEN_CMDB: $(TOKEN_CMDB)
    TOKEN_DEFECT_DOJO: $(TOKEN_DEFECT_DOJO)