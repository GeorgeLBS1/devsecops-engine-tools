---
metadata:
  name: "Check that ELB has configured DDOS Shield use case 3 and 4"
  id: "CKV2_AWS_108"
  category: "GENERAL_SECURITY"
definition:
  and:
############################ FILTRO PARA TIPOS DE RECURSOS ############################
    - cond_type: "filter"
      attribute: "resource_type"
      value:
      - "AWS::ElasticLoadBalancing::LoadBalancer"
      - "AWS::ElasticLoadBalancingV2::LoadBalancer"
      operator: "within"
    - or:
############################ Only Application ############################    
      - and: 
        - cond_type: "attribute"
          resource_types:
          - "AWS::ElasticLoadBalancing::LoadBalancer"
          - "AWS::ElasticLoadBalancingV2::LoadBalancer"
          attribute: "Type"
          operator: "not_equals"
          value: "Application"     
############################ ALB SCHEME internal ############################
      - and:
        - cond_type: "attribute"
          resource_types:
          - "AWS::ElasticLoadBalancing::LoadBalancer"
          - "AWS::ElasticLoadBalancingV2::LoadBalancer"
          attribute: "Scheme"
          operator: "exists"
        - cond_type: "attribute"
          resource_types:
          - "AWS::ElasticLoadBalancing::LoadBalancer"
          - "AWS::ElasticLoadBalancingV2::LoadBalancer"
          attribute: "Scheme"
          operator: "equals"
          value: "internal"
############################ ALB SCHEME internet-facing ############################
      - and:
        - or:
          - cond_type: "attribute"
            resource_types:
            - "AWS::ElasticLoadBalancing::LoadBalancer"
            - "AWS::ElasticLoadBalancingV2::LoadBalancer"
            attribute: "Scheme"
            operator: "not_exists"
          - and:
            - cond_type: "attribute"
              resource_types:
              - "AWS::ElasticLoadBalancing::LoadBalancer"
              - "AWS::ElasticLoadBalancingV2::LoadBalancer"
              attribute: "Scheme"
              operator: "exists"
            - cond_type: "attribute"
              resource_types:
              - "AWS::ElasticLoadBalancing::LoadBalancer"
              - "AWS::ElasticLoadBalancingV2::LoadBalancer"
              attribute: "Scheme"
              operator: "equals"
              value: "internet-facing"
#################################### NO EXISTE CLOUDFRONT O EXISTE CLOUDFRONT PERO CON CUSTOM ORIGIN NO VINCULADO AL ALB ###################################
        - and:
          - or:
            - and:
              - cond_type: "attribute"
                resource_types:
                - "AWS::CloudFront::Distribution"
                attribute: "DistributionConfig.Origins.S3OriginConfig"
                operator: "not_exists"
              - cond_type: "attribute"
                resource_types:
                - "AWS::CloudFront::Distribution"
                attribute: "DistributionConfig.Origins.CustomOriginConfig"
                operator: "not_exists"
            - and:
              - cond_type: "attribute"
                resource_types:
                - "AWS::CloudFront::Distribution"
                attribute: "DistributionConfig.Origins.CustomOriginConfig"
                operator: "exists"
              - cond_type: "connection"
                resource_types:
                - "AWS::CloudFront::Distribution"
                connected_resource_types:
                - "AWS::ElasticLoadBalancing::LoadBalancer"
                - "AWS::ElasticLoadBalancingV2::LoadBalancer"
                operator: "not_exists"
          - cond_type: "connection"
            resource_types:
            - "AWS::ElasticLoadBalancing::LoadBalancer"
            - "AWS::ElasticLoadBalancingV2::LoadBalancer"
            connected_resource_types:
            - "Custom::customaclupdate"
            operator: "exists"
#################################### CAMPOS DE CUSTOM ACL UPDATE CON IMPERVA ###################################
          - and:
            - cond_type: "attribute"
              resource_types:
              - "Custom::customaclupdate"
              attribute: "ServiceToken"
              operator: "exists"
            - cond_type: "attribute"
              resource_types:
              - "Custom::customaclupdate"
              attribute: "ServiceToken"
              operator: "equals"
              value: "arn:aws:sns:us-east-1:831688958710:Antiddos-ACLUpdate-sns"
            - cond_type: "attribute"
              resource_types:
              - "Custom::customaclupdate"
              attribute: "scope"
              operator: "exists"
            - cond_type: "attribute"
              resource_types:
              - "Custom::customaclupdate"
              attribute: "scope"
              operator: "equals"
              value: "REGIONAL"
            - cond_type: "attribute"
              resource_types:
              - "Custom::customaclupdate"
              attribute: "Kinesis_arn"
              operator: "exists"
            - or:
              - cond_type: "attribute"
                resource_types:
                - "Custom::customaclupdate"
                attribute: "Kinesis_arn"
                operator: "regex_match"
                value: ".*aws-waf-logs-pdn-*."
              - cond_type: "attribute"
                resource_types:
                - "Custom::customaclupdate"
                attribute: "Kinesis_arn"
                operator: "regex_match"
                value: ".*aws-waf-logs-devqa-*."
            - cond_type: "attribute"
              resource_types:
              - "Custom::customaclupdate"
              attribute: "ipset_imperva"
              operator: "exists"
            - cond_type: "attribute"
              resource_types:
              - "Custom::customaclupdate"
              attribute: "ipset_imperva"
              operator: "equals"
              value: "IpSetAlb"
            - cond_type: "attribute"
              resource_types:
              - "Custom::customaclupdate"
              attribute: "ipset_route53"
              operator: "exists"
            - cond_type: "attribute"
              resource_types:
              - "Custom::customaclupdate"
              attribute: "ipset_route53"
              operator: "equals"
              value: "IpSetHealthcheck"
            - cond_type: "attribute"
              resource_types:
              - "Custom::customaclupdate"
              attribute: "change_webacl"
              operator: "exists"
            - cond_type: "attribute"
              resource_types:
              - "Custom::customaclupdate"
              attribute: "change_webacl"
              operator: "equals"
              value: true
            - cond_type: "attribute"
              resource_types:
              - "Custom::customaclupdate"
              attribute: "waf_name"
              operator: "exists"
            - or:
              - cond_type: "attribute"
                resource_types:
                - "Custom::customaclupdate"
                attribute: "waf_name"
                operator: "equals"
                value: "Regional1"
              - cond_type: "attribute"
                resource_types:
                - "Custom::customaclupdate"
                attribute: "waf_name"
                operator: "equals"
                value: "Regional2"
