---
metadata:
  name: "Ensure SNS has data in transit enabled"
  id: "CKV2_AWS_146"
  category: "GENERAL_SECURITY"
definition:
  and:
    - cond_type: "filter"
      attribute: "resource_type"
      value:
        - "AWS::SNS::TopicPolicy"
      operator: "within"
    - cond_type: "attribute"
      resource_types:
        - "AWS::SNS::TopicPolicy"
      attribute: "Queues"
      operator: "exists"
    - cond_type: "attribute"
      resource_types:
        - "AWS::SNS::TopicPolicy"
      attribute: "Queues"
      operator: "is_not_empty"
    - cond_type: "attribute"
      resource_types:
        - "AWS::SNS::TopicPolicy"
      attribute: "PolicyDocument"
      operator: "exists"
    - cond_type: attribute
      attribute: PolicyDocument.Statement.*.Effect
      operator: equals
      value: "Deny"
      resource_types:
        - AWS::SNS::TopicPolicy
    - or:
          - cond_type: attribute
            attribute: PolicyDocument.Statement.*.Action.*
            operator: equals
            value: "sqs:*"
            resource_types:
              - AWS::SNS::TopicPolicy
          - cond_type: attribute
            attribute: PolicyDocument.Statement.*.Action
            operator: equals
            value: "sqs:*"
            resource_types:
              - AWS::SNS::TopicPolicy    
    - cond_type: "attribute"
      attribute: "PolicyDocument.Statement.*.Condition.Bool.aws:SecureTransport"
      operator: "is_not_empty"
      resource_types:
        - "AWS::SNS::TopicPolicy"
    - and:
        - cond_type: "attribute"
          resource_types:
            - "AWS::SNS::TopicPolicy"
          attribute: "PolicyDocument.Statement.*.Condition.Bool.aws:SecureTransport"
          operator: "equals"
          value: false
